{% extends "base.html" %}
{% load static %}
{% block additionalHead %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.12.6/css/selectize.default.min.css" />
<link href="https://cdn.jsdelivr.net/npm/filepond@4.30.4/dist/filepond.min.css" rel="stylesheet">
    <!-- Подключаем плагин для предпросмотра изображений -->
    <link href="https://cdn.jsdelivr.net/npm/filepond-plugin-image-preview@4.3.1/dist/filepond-plugin-image-preview.min.css" rel="stylesheet">
{% endblock %}

{% block title %}Отчет{% endblock %}

{% block pageTitle %}Отчет о проблеме{% endblock %}

{% block content %}
{% if not report.status == 'in_moderation' or user.is_authenticated and report.user == user %}
<style>
    p, h2{
    word-break: break-all;}
    p{
    font-size: 1.2em;
    }

</style>
    <div class="report-details">
        <h2>{{ report.title }}</h2>


        <!-- Описание проблемы -->
        {% if report.description %}
            <p ><strong>Описание:</strong> {{ report.description }}</p>
        {% endif %}

        <!-- Статус -->
        <p><strong>Статус:</strong> {{ report.get_status_display }}</p>

        <!-- Дата создания и обновления -->
        <p><strong>Дата создания:</strong> {{ report.created_at|date:"d.m.Y H:i" }}</p>
        {% if report.updated_at %}
            <p><strong>Дата обновления:</strong> {{ report.updated_at|date:"d.m.Y H:i" }}</p>
        {% endif %}

        <!-- Адрес и кнопка для отображения карты -->
        {% if report.address %}
            <p><strong>Адрес:</strong> {{ report.address }}</p>
            <button id="showMapButton" class="btn btn-primary">Показать на карте</button>
        {% endif %}

        <!-- Карта с маркером -->
        <div id="map" style="height: 400px; display: none;"></div>

        <!-- Галерея изображений -->
        {% if report_images %}
        <h3> Фото </h3>
        <hr>
        <div class="gallery">

            {% for report_image in report_images %}
            <div class="gallery-item">
                {% if report_image.image.url %}
                <img src="{{ report_image.image.url }}" alt="Изображение проблемы" class="gallery-image"
                     onclick="openModal('{{ report_image.image.url }}')">
                {% endif %}
            </div>
            {% endfor %}

        </div>
        <hr>
        {% else %}
        <h3> Нет прикрепленных фото к этой проблеме</h3>
        {% endif %}
        <!-- Модальное окно для увеличенного изображения -->
        <div id="imageModal" class="modal" style="display: none;">
            <span class="close" onclick="closeModal()">&times;</span>
            <img class="modal-content" id="modalImage">
        </div>

        <!-- Комментарии -->
        <div class="comments-section">
            <h3>Комментарии</h3>
            {% if report.comments.count > 0 %}
                <ul>
                    {% for comment in report.comments.all %}
                        <li>
                            <strong>{{ comment.user.username }}</strong>: {{ comment.text }} ({{ comment.created_at|date:"d.m.Y H:i" }})
                            {% if comment.image %}
                                <br><img src="{{ comment.image.url }}" alt="Изображение комментария" class="comment-image">
                            {% endif %}
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>Комментариев нет.</p>
            {% endif %}
        </div>

        <!-- Форма добавления комментария и изображений, если пользователь авторизован -->
        {% if user.is_authenticated %}
            <div class="add-comment-form">
                <h3>Оставьте комментарий:</h3>
                <form method="POST" action="{% url 'reports:add_comment' report_id=report.id %}" enctype="multipart/form-data">
                    {% csrf_token %}

                    <!-- Поле для текста комментария -->
                    <p>
                        <p><textarea id="text" name="text" rows="5" cols="50" placeholder="Введите ваш комментарий..." style="resize: none; width:100%;" maxlength="350">{{ form.text.value }}</textarea>
                <p class="info">ℹ️ Максимум 350 символов</p>
                </p>

                    <!-- Показываем ошибки, если они есть -->
                    {% if errors %}
                        <div class="errors">
                            <ul>
                                {% for field, error_list in errors.items %}
                                    <li><strong>{{ field }}:</strong>
                                        <ul>
                                            {% for error in error_list %}
                                                <li>{{ error }}</li>
                                            {% endfor %}
                                        </ul>
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% endif %}

                    <!-- Поле для загрузки изображений -->
                    <p>
                        <input type="file" id="filepond" class="filepond" name="file" multiple>
                    </p>
                    <p class="info">ℹ️ Выберите или перетащите фотографию / группу фотографий. Фотографий должно быть не больше 5 штук, форматом jpg, jpeg png, heic, heif, размером не более 5 мб каждая</p>

                    <button type="submit" class="btn-comment">Отправить комментарий</button>
                </form>
            </div>
        {% else %}
            <p>Чтобы оставить комментарий, пожалуйста, войдите в систему.</p>
        {% endif %}
    </div>
{% else %}
<h2>Эта заявка находится на модерации и доступ к ней закрыт</h2>
<a href="{% url 'reports:reports' %}">Вернуться к списку отчетов?</a>
{% endif %}

{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
    function openModal(imageSrc) {
    var modal = document.getElementById("imageModal");
    var modalImage = document.getElementById("modalImage");
    modal.style.display = "flex";
    modalImage.src = imageSrc;

}

function closeModal() {
    var modal = document.getElementById("imageModal");
    modal.style.display = "none";
}

    sessionStorage.clear();

    document.getElementById('showMapButton').addEventListener('click', function() {
        var mapElement = document.getElementById('map');
        var button = document.getElementById('showMapButton');

        if (mapElement.style.display === 'none') {
            mapElement.style.display = 'block';
            button.textContent = 'Скрыть карту';

            // Инициализация карты
            var map = L.map(mapElement).setView([{{ report.latitude }}, {{ report.longitude }}], 13);

            // Добавление OpenStreetMap Tile Layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // Добавление маркера
            L.marker([{{ report.latitude }}, {{ report.longitude }}]).addTo(map)
                .bindPopup("<b>{{ report.title }}</b><br>{{ report.description }}")
                .openPopup();
        } else {
            mapElement.style.display = 'none';
            button.textContent = 'Показать на карте';
        }
    });

</script>
<script src="https://cdn.jsdelivr.net/npm/compressorjs@1.0.5/dist/compressor.min.js"></script>

    <!-- Подключаем JavaScript для FilePond и плагинов -->
    <script src="https://cdn.jsdelivr.net/npm/filepond@4.30.4/dist/filepond.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/filepond-plugin-image-preview@4.3.1/dist/filepond-plugin-image-preview.min.js"></script>

    <script src="{% static 'js/step3.js' %}"></script>
{% endblock %}
